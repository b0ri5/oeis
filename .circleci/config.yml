# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  renovate: daniel-shuy/renovate@3.1.0
jobs:
  test:
    # Use a machine executor because it most easily supports multiple languages
    machine:
      # See https://circleci.com/docs/2.0/configuration-reference/#available-machine-images for the list of images
      image: ubuntu-2004:202107-02
    steps:
      - checkout
      # Use the latest version of python available as reported via "pyenv install -l"
      - run: pyenv global 3.9.4
      # Install bazelisk. See https://github.com/bazelbuild/bazelisk#requirements
      - run: go get github.com/bazelbuild/bazelisk
      - run: bazelisk test --test_output=errors //...
  check-buildifier:
    docker:
      # See https://circleci.com/developer/images/image/cimg/go for a list of images
      - image: cimg/go:1.17.3@sha256:bbfdc93905d54d2124721b0eff780ce2a2a9f7c370c0ca084cf48792b3d1877b
    steps:
      - checkout
      - run: go get github.com/bazelbuild/buildtools/buildifier
      - run: bash .circleci/check_buildifier
      - run:
          command: echo "Run .circleci/fix_buildifier"
          when: on_fail
  check-python:
    docker:
      # See https://circleci.com/developer/images/image/cimg/python for a list of images
      - image: cimg/python:3.10.0@sha256:fa7ea2e22e91ed3b4184e45bab22dad0fb71d75a13af3cffcd67ab6cde2b926c
    steps:
      - checkout
      - run: pip install -r requirements.txt
      - run: pip install pylint
      # It would be nice to keep invalid-name but it is too convenient to use the oeis sequence and "n"
      - run: find . -name "*.py" | xargs pylint --disable=missing-docstring --disable=too-many-public-methods --disable=invalid-name
  # See https://github.com/google/yapf
  check-yapf:
    docker:
      # See https://circleci.com/developer/images/image/cimg/python for a list of images
      - image: cimg/python:3.10.0@sha256:fa7ea2e22e91ed3b4184e45bab22dad0fb71d75a13af3cffcd67ab6cde2b926c
    steps:
      - checkout
      - run: pip install yapf
      - run: find . -name "*.py" | xargs yapf --parallel --style google --diff
      - run:
          command: |
            echo "Run find . -name "*.py" | xargs yapf --parallel --style google --in-place"
          when: on_fail

workflows:
  test-workflow:
    jobs:
      - check-buildifier
      - check-python
      - check-yapf
      - renovate/validate-config
      - test
